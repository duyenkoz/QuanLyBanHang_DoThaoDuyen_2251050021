{% extends 'admin/layout_admin/base.html' %}
{% block title %}Dashboard{% endblock %}
{% block content %}
<div class="row">
    <div class="col-12 col-sm-6 col-xl-3 mb-4">
        <div class="card border-0 shadow">
            <div class="card-body">
                <div class="row d-block d-xl-flex align-items-center">
                    <div class="col-12 col-xl-5 text-xl-center mb-3 mb-xl-0 d-flex align-items-center justify-content-xl-center">
                        <div class="icon-shape icon-shape-tertiary rounded me-4 me-sm-0">
                            <svg class="icon" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M3 3a1 1 0 000 2v8a2 2 0 002 2h2.586l-1.293 1.293a1 1 0 101.414 1.414L10 15.414l2.293 2.293a1 1 0 001.414-1.414L12.414 15H15a2 2 0 002-2V5a1 1 0 100-2H3zm11.707 4.707a1 1 0 00-1.414-1.414L10 9.586 8.707 8.293a1 1 0 00-1.414 0l-2 2a1 1 0 101.414 1.414L8 10.414l1.293 1.293a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>
                        </div>
                        <div class="d-sm-none">
                            <h2 class="fw-extrabold h5"> Sản phẩm</h2>
                            <h3 class="mb-1">{{ data.get("count_products", 0)}}</h3>
                        </div>
                    </div>
                    <div class="col-12 col-xl-7 px-xl-0">
                        <div class="d-none d-sm-block">
                            <h2 class="h6 text-gray-400 mb-0"> Sản phẩm</h2>
                            <h3 class="fw-extrabold mb-2">{{ data.get("count_products", 0)}}</h3>
                        </div>
                        <!-- <small class="text-gray-500">
                            Feb 1 - Apr 1
                        </small> 
                        <div class="small d-flex mt-1">                               
                            <div>Since last month <svg class="icon icon-xs text-success" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clip-rule="evenodd"></path></svg><span class="text-success fw-bolder">4%</span></div>
                        </div> -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-12 col-sm-6 col-xl-3 mb-4">
        <div class="card border-0 shadow">
            <div class="card-body">
                <div class="row d-block d-xl-flex align-items-center">
                    <div class="col-12 col-xl-5 text-xl-center mb-3 mb-xl-0 d-flex align-items-center justify-content-xl-center">
                        <div class="icon-shape icon-shape-success rounded me-4 me-sm-0">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><!--!Font Awesome Free v7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.--><path d="M320 80C377.4 80 424 126.6 424 184C424 241.4 377.4 288 320 288C262.6 288 216 241.4 216 184C216 126.6 262.6 80 320 80zM96 152C135.8 152 168 184.2 168 224C168 263.8 135.8 296 96 296C56.2 296 24 263.8 24 224C24 184.2 56.2 152 96 152zM0 480C0 409.3 57.3 352 128 352C140.8 352 153.2 353.9 164.9 357.4C132 394.2 112 442.8 112 496L112 512C112 523.4 114.4 534.2 118.7 544L32 544C14.3 544 0 529.7 0 512L0 480zM521.3 544C525.6 534.2 528 523.4 528 512L528 496C528 442.8 508 394.2 475.1 357.4C486.8 353.9 499.2 352 512 352C582.7 352 640 409.3 640 480L640 512C640 529.7 625.7 544 608 544L521.3 544zM472 224C472 184.2 504.2 152 544 152C583.8 152 616 184.2 616 224C616 263.8 583.8 296 544 296C504.2 296 472 263.8 472 224zM160 496C160 407.6 231.6 336 320 336C408.4 336 480 407.6 480 496L480 512C480 529.7 465.7 544 448 544L192 544C174.3 544 160 529.7 160 512L160 496z"/></svg>
                        </div>
                        <div class="d-sm-none">
                            <h2 class="fw-extrabold h5"> Khách hàng</h2>
                            <h3 class="mb-1">{{ data.get("count_users", 0)}}</h3>
                        </div>
                    </div>
                    <div class="col-12 col-xl-7 px-xl-0">
                        <div class="d-none d-sm-block">
                            <h2 class="h6 text-gray-400 mb-0"> Khách hàng</h2>
                            <h3 class="fw-extrabold mb-2">{{ data.get("count_users", 0)}}</h3>
                        </div>
                        <!-- <small class="text-gray-500">
                            Feb 1 - Apr 1
                        </small> 
                        <div class="small d-flex mt-1">                               
                            <div>Since last month <svg class="icon icon-xs text-success" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clip-rule="evenodd"></path></svg><span class="text-success fw-bolder">4%</span></div>
                        </div> -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-12 col-sm-6 col-xl-3 mb-4">
        <div class="card border-0 shadow">
            <div class="card-body">
                <div class="row d-block d-xl-flex align-items-center">
                    <div class="col-12 col-xl-5 text-xl-center mb-3 mb-xl-0 d-flex align-items-center justify-content-xl-center">
                        <div class="icon-shape icon-shape-info rounded me-4 me-sm-0">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><!--!Font Awesome Free v7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.--><path d="M439.4 96L448 96C483.3 96 512 124.7 512 160L512 512C512 547.3 483.3 576 448 576L192 576C156.7 576 128 547.3 128 512L128 160C128 124.7 156.7 96 192 96L200.6 96C211.6 76.9 232.3 64 256 64L384 64C407.7 64 428.4 76.9 439.4 96zM376 176C389.3 176 400 165.3 400 152C400 138.7 389.3 128 376 128L264 128C250.7 128 240 138.7 240 152C240 165.3 250.7 176 264 176L376 176zM320 408C350.9 408 376 382.9 376 352C376 321.1 350.9 296 320 296C289.1 296 264 321.1 264 352C264 382.9 289.1 408 320 408zM226.3 477C213.4 492.6 228.5 512 248.7 512L391.2 512C411.4 512 426.5 492.6 413.6 477C398.9 459.3 376.7 448 351.9 448L287.9 448C263.1 448 240.9 459.3 226.2 477z"/></svg>
                        </div>
                        <div class="d-sm-none">
                            <h2 class="fw-extrabold h5"> Nhân viên</h2>
                            <h3 class="mb-1">{{ data.get("count_staff", 0)}}</h3>
                        </div>
                    </div>
                    <div class="col-12 col-xl-7 px-xl-0">
                        <div class="d-none d-sm-block">
                            <h2 class="h6 text-gray-400 mb-0"> Nhân viên</h2>
                            <h3 class="fw-extrabold mb-2">{{ data.get("count_staff", 0)}}</h3>
                        </div>
                        <!-- <small class="text-gray-500">
                            Feb 1 - Apr 1
                        </small> 
                        <div class="small d-flex mt-1">                               
                            <div>Since last month <svg class="icon icon-xs text-success" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clip-rule="evenodd"></path></svg><span class="text-success fw-bolder">4%</span></div>
                        </div> -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-12 col-sm-6 col-xl-3 mb-4">
        <div class="card border-0 shadow">
            <div class="card-body">
                <div class="row d-block d-xl-flex align-items-center">
                    <div class="col-12 col-xl-5 text-xl-center mb-3 mb-xl-0 d-flex align-items-center justify-content-xl-center">
                        <div class="icon-shape icon-shape-purple rounded me-4 me-sm-0">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><!--!Font Awesome Free v7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.--><path d="M296.5 69.2C311.4 62.3 328.6 62.3 343.5 69.2L562.1 170.2C570.6 174.1 576 182.6 576 192C576 201.4 570.6 209.9 562.1 213.8L343.5 314.8C328.6 321.7 311.4 321.7 296.5 314.8L77.9 213.8C69.4 209.8 64 201.3 64 192C64 182.7 69.4 174.1 77.9 170.2L296.5 69.2zM112.1 282.4L276.4 358.3C304.1 371.1 336 371.1 363.7 358.3L528 282.4L562.1 298.2C570.6 302.1 576 310.6 576 320C576 329.4 570.6 337.9 562.1 341.8L343.5 442.8C328.6 449.7 311.4 449.7 296.5 442.8L77.9 341.8C69.4 337.8 64 329.3 64 320C64 310.7 69.4 302.1 77.9 298.2L112 282.4zM77.9 426.2L112 410.4L276.3 486.3C304 499.1 335.9 499.1 363.6 486.3L527.9 410.4L562 426.2C570.5 430.1 575.9 438.6 575.9 448C575.9 457.4 570.5 465.9 562 469.8L343.4 570.8C328.5 577.7 311.3 577.7 296.4 570.8L77.9 469.8C69.4 465.8 64 457.3 64 448C64 438.7 69.4 430.1 77.9 426.2z"/></svg>
                        </div>
                        <div class="d-sm-none">
                            <h2 class="fw-extrabold h5"> Danh mục</h2>
                            <h3 class="mb-1">{{ data.get("count_categories", 0)}}</h3>
                        </div>
                    </div>
                    <div class="col-12 col-xl-7 px-xl-0">
                        <div class="d-none d-sm-block">
                            <h2 class="h6 text-gray-400 mb-0"> Danh mục</h2>
                            <h3 class="fw-extrabold mb-2">{{ data.get("count_categories", 0)}}</h3>
                        </div>
                        <!-- <small class="text-gray-500">
                            Feb 1 - Apr 1
                        </small> 
                        <div class="small d-flex mt-1">                               
                            <div>Since last month <svg class="icon icon-xs text-success" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clip-rule="evenodd"></path></svg><span class="text-success fw-bolder">4%</span></div>
                        </div> -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-12">
        <div class="row mb-3">
            <!-- <div class="col-2">
                <select id="viewMode" class="form-select">
                    <option value="day">Theo ngày</option>
                    <option value="month">Theo tháng</option>
                    <option value="year">Theo năm</option>
                </select>
            </div> -->
            <div class="col-2" id="filterContainer">
                <input type="text" name="daterange" class="form-control" id="search-date" placeholder="Tìm kiếm theo ngày" />
            </div>
        </div>
        <div>
            <span class="badge rounded-pill bg-success">Biểu đồ doanh thu theo thời gian</span>
            <canvas id="chartRevenue" class="chart-statistics"></canvas>
        </div>
        <div>
            <span class="badge rounded-pill bg-info">Biểu đồ đơn hàng theo thời gian</span>
            <canvas id="chartOrder" class="chart-statistics"></canvas>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script type="text/javascript">
    $(document).ready(function(){
        let mode = $("#viewMode").val();
        initControl(mode).then((drp) => {
            fetchRevenueData(drp);
            fetchOrderData(drp);
            $("#search-date").on("hide.daterangepicker", function (ev, picker) {
                fetchRevenueData(picker);
                fetchOrderData(picker);
            });
        });
        
        //Nghe sự kiện
        // $("#viewMode").on("change", function() {
        //     mode = $(this).val();
        //     initControl(mode).then(drp => {
        //         fetchRevenueData(drp, mode);

        //         $("#search-date").off("apply.daterangepicker").on("apply.daterangepicker", function(ev, drpInstance) {
        //             fetchRevenueData(drpInstance, mode);
        //         });
        //     });
        // });
    });

    function initControl(mode) {
        return new Promise((resolve, reject) => {
            try {
                let format = "DD/MM/YYYY";
                if (mode === "month") format = "MM/YYYY";
                if (mode === "year") format = "YYYY";
                const picker = $("#search-date").daterangepicker({
                    opens: "left",
                    startDate:moment().subtract(29, "days"),
                    endDate: moment(),
                    locale: {
                        format: format,
                    },
                    ranges: {
                        "Hôm nay": [moment(), moment()],
                        "Hôm qua": [moment().subtract(1, "days"), moment().subtract(1, "days")],
                        "7 ngày trước": [moment().subtract(6, "days"), moment()],
                        "30 ngày trước": [moment().subtract(29, "days"), moment()],
                        "Tháng này": [moment().startOf("month"), moment().endOf("month")],
                        "Tháng trước": [moment().subtract(1, "month").startOf("month"), moment().subtract(1, "month").endOf("month")],
                    }
                }).data("daterangepicker");
                resolve(picker);
            } catch (error) {
                reject(error);
            }
        });
    }

    function fetchRevenueData(picker, mode) {
        const fromDate = picker.startDate.format("YYYY-MM-DD");
        const toDate = picker.endDate.format("YYYY-MM-DD");

        $.ajax({
            url: `/admin/api/chart/revenue?from=${fromDate}&to=${toDate}&mode=${mode || "day"}`,
            method: "GET",
            dataType: "json",
            success: function(response) {
                if (response.status_code === "SUCCESS") {
                    const chartData = response.data;
                    const labels = chartData?.labels;
                    const revenues = chartData?.revenues;

                    if (!labels || !revenues) {
                        toastError("Dữ liệu biểu đồ không hợp lệ");
                        return;
                    }

                    //Khởi tạo biểu đồ
                    window.revenueChart = initRevenueChart(labels, revenues);
                } else {
                    console.error("Failed to fetch revenue chart data:", response.message);
                }
            },
            error: function(xhr, status, error) {
                console.error("Error fetching revenue chart data:", error);
            }
        });
    }

    function fetchOrderData(picker, mode) {
        const fromDate = picker.startDate.format("YYYY-MM-DD");
        const toDate = picker.endDate.format("YYYY-MM-DD");

        $.ajax({
            url: `/admin/api/chart/order?from=${fromDate}&to=${toDate}&mode=${mode || "day"}`,
            method: "GET",
            dataType: "json",
            success: function(response) {
                if (response.status_code === "SUCCESS") {
                    const chartData = response.data;
                    const labels = chartData?.labels;
                    const orderCounts = chartData?.orders;

                    if (!labels || !orderCounts) {
                        toastError("Dữ liệu biểu đồ không hợp lệ");
                        return;
                    }

                    //Khởi tạo biểu đồ
                    window.orderChart = initOrderChart(labels, orderCounts);
                } else {
                    console.error("Failed to fetch order chart data:", response.message);
                }
            },
            error: function(xhr, status, error) {
                console.error("Error fetching order chart data:", error);
            }
        });
    }

    function initRevenueChart(labels, revenues) {
        if (window.revenueChart) {
            window.revenueChart.destroy();
        }

        const ctxChartRevenue = document.getElementById('chartRevenue').getContext('2d');
        const revenueChart = new Chart(ctxChartRevenue, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Doanh thu',
                    data: revenues,
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.3)',
                    borderWidth: 1,
                    fill: true,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        title: {
                            display: true,
                            text: 'Doanh thu (VND)'
                        },
                        beginAtZero: true,
                        ticks:{
                            stepSize: 300000
                        }
                    }
                }                
            }
        });
        return revenueChart;
    }

    function initOrderChart(labels, orderCounts) {
        if (window.orderChart) {
            window.orderChart.destroy();
        }
        const ctxChartOrder = document.getElementById('chartOrder').getContext('2d');
        const orderChart = new Chart(ctxChartOrder, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Số đơn hàng',
                    data: orderCounts,
                    borderColor: 'rgb(54, 162, 235)',
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        title: {
                            display: true,
                            text: 'Số đơn hàng'
                        },
                        beginAtZero: true,
                        ticks:{
                            stepSize: 10
                        }
                    }
                },
                interaction: {
                    mode: 'nearest',   // bắt điểm gần nhất
                    intersect: false   // không cần hover trúng chính xác
                },
            }
        });
        return orderChart;
    }
</script>
{% endblock %}