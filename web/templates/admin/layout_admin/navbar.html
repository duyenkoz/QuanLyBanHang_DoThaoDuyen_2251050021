<!-- <link rel="stylesheet" href="{{ url_for('static', filename='css/admin/volt_sidebar.css') }}"> -->
<nav class="navbar navbar-top navbar-expand navbar-dashboard navbar-dark ps-0 pe-2 pb-0">
  <div class="container-fluid-product px-0">
    <div class="d-flex justify-content-between w-100" id="navbarSupportedContent">
      <div class="d-flex align-items-center">
        <!-- Search form -->
        <!-- <form class="navbar-search form-inline" id="navbar-search-main">
          <div class="input-group input-group-merge search-bar">
            <span class="input-group-text" id="topbar-addon">
              <svg class="icon icon-xs" x-description="Heroicon name: solid/search" xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                <path fill-rule="evenodd"
                  d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z"
                  clip-rule="evenodd"></path>
              </svg>
            </span>
            <input type="text" class="form-control" id="topbarInputIconLeft" placeholder="Search" aria-label="Search"
              aria-describedby="topbar-addon">
          </div>
        </form> -->
        <!-- / Search form -->
      </div>
      <!-- Navbar links -->
      <ul class="navbar-nav align-items-center">
        <li class="nav-item dropdown">
          <a class="nav-link text-dark notification-bell unread dropdown-toggle" data-unread-notifications="true"
            href="#" role="button" data-bs-toggle="dropdown" data-bs-display="static" aria-expanded="false">
            <svg class="icon icon-sm text-gray-900" fill="currentColor" viewBox="0 0 20 20"
              xmlns="http://www.w3.org/2000/svg">
              <path
                d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z">
              </path>
            </svg>
          </a>
        </li>
        <li class="nav-item dropdown ms-lg-3">
          <a class="nav-link dropdown-toggle pt-1 px-0" href="#" role="button" data-bs-toggle="dropdown"
            aria-expanded="false">
            <div class="media d-flex align-items-center">
              <img class="avatar rounded-circle" alt="Image placeholder" src="/static/images/user-avatar-male.png">
              <div class="media-body ms-2 text-dark align-items-center d-none d-lg-block">
                <span class="mb-0 font-small fw-bold text-gray-900">{{ session.get('user_name') }}</span>
              </div>
            </div>
          </a>
          <div class="dropdown-menu dashboard-dropdown dropdown-menu-end mt-2 py-1">
            <a class="dropdown-item d-flex align-items-center" href="#" data-bs-toggle="modal"
              data-bs-target="#accountModal" id="openAccountModal">
              <svg class="dropdown-icon text-gray-400 me-2" fill="currentColor" viewBox="0 0 20 20"
                xmlns="http://www.w3.org/2000/svg">
                <path fill-rule="evenodd"
                  d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-6-3a2 2 0 11-4 0 2 2 0 014 0zm-2 4a5 5 0 00-4.546 2.916A5.986 5.986 0 0010 16a5.986 5.986 0 004.546-2.084A5 5 0 0010 11z"
                  clip-rule="evenodd"></path>
              </svg>
              Tài khoản
            </a>
            <div role="separator" class="dropdown-divider my-1"></div>
            <a class="dropdown-item d-flex align-items-center" href="/logout">
              <svg class="dropdown-icon text-danger me-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1">
                </path>
              </svg>
              Đăng xuất
            </a>
          </div>
        </li>
      </ul>
    </div>
  </div>
</nav>
<!-- Modal thông tin tài khoản -->
<div class="modal fade" id="accountModal" tabindex="-1" aria-labelledby="accountModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title text-success fw-bold" id="accountModalLabel">Thông tin tài khoản</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <form id="accountForm">
          <div class="mb-3">
            <label class="form-label">Họ & tên</label>
            <input type="text" class="form-control" id="name" name="name"
              value="{{ session.get('user_name') or session.get('role') }}" readonly>
          </div>
          <div class="mb-3">
            <label class="form-label">Số điện thoại</label>
            <input type="text" class="form-control" id="phone" name="phone" value="{{ session.get('user_phone') }}"
              readonly>
          </div>
          <div class="mb-3">
            <label class="form-label">Email</label>
            <input type="email" class="form-control" id="email" name="email" value="{{ user.Email if user else '' }}"
              readonly>
          </div>
        </form>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-primary" id="accountEditBtn">Cập nhật</button>
        <button type="button" class="btn btn-success d-none" id="accountSaveBtn">Lưu</button>
        <button type="button" class="btn btn-secondary d-none" id="accountCancelBtn">Hủy</button>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const accountModal = document.getElementById("accountModal");
    const nameInput = document.getElementById("name");
    const phoneInput = document.getElementById("phone");
    const emailInput = document.getElementById("email");

    const editBtn = document.getElementById("accountEditBtn");
    const saveBtn = document.getElementById("accountSaveBtn");
    const cancelBtn = document.getElementById("accountCancelBtn");

    const avatarNameSpan = document.querySelector(".media-body span"); // Tên hiển thị cạnh avatar

    let originalData = {};

    saveBtn.focus();

    // Khi mở modal -> load dữ liệu từ server
    accountModal.addEventListener("show.bs.modal", function () {
      fetch("/admin/get_profile")
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            originalData = { ...data.user };
            nameInput.value = data.user.name;
            phoneInput.value = data.user.phone;
            emailInput.value = data.user.email;
            setReadOnly(true);
            toggleButtons("view");
          }
        });
    });

    editBtn.addEventListener("click", function () {
      setReadOnly(false);
      phoneInput.readOnly = true; // SĐT luôn không chỉnh
      toggleButtons("edit");
      
    });

    // Nút Hủy
    cancelBtn.addEventListener("click", function () {
      nameInput.value = originalData.name;
      phoneInput.value = originalData.phone;
      emailInput.value = originalData.email;
      setReadOnly(true);
      toggleButtons("view");
    });

    // Nút Lưu
    saveBtn.addEventListener("click", function () {
      const formData = new FormData();
      formData.append("name", nameInput.value.trim());
      formData.append("phone", phoneInput.value.trim());
      formData.append("email", emailInput.value.trim());

      fetch("/admin/update_profile", {
        method: "POST",
        body: formData
      })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            // Lưu lại dữ liệu mới
            originalData = { ...data.user };

            // Set form về readonly
            setReadOnly(true);

            // Đổi nút về chế độ xem
            toggleButtons("view");

            // Cập nhật tên ở avatar
            avatarNameSpan.textContent = data.user.name;
          } else {
            alert(data.message || "Lỗi khi cập nhật");
          }
        })
        .catch(() => alert("Có lỗi xảy ra khi lưu thông tin"));
    });
    // Hàm set readonly cho form
    function setReadOnly(readonly) {
      nameInput.readOnly = readonly;
      emailInput.readOnly = readonly;
      phoneInput.readOnly = true; // luôn readonly
    }

    // Hàm đổi nút hiển thị
    function toggleButtons(mode) {
      if (mode === "view") {
        editBtn.classList.remove("d-none");
        saveBtn.classList.add("d-none");
        cancelBtn.classList.add("d-none");
      } else if (mode === "edit") {
        editBtn.classList.add("d-none");
        saveBtn.classList.remove("d-none");
        cancelBtn.classList.remove("d-none");
      }
    }
  });
</script>