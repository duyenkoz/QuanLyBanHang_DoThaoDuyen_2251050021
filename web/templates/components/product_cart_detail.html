<div class="container py-4">
    <div class="row g-4 justify-content-center">

        <!-- ·∫¢nh s·∫£n ph·∫©m -->
        <div class="col-md-6">
            <div class="bg-light p-4 text-center rounded">
                <img src="{{ url_for('static', filename='images/' + product.Img) }}" alt="{{ product.Title }}"
                    class="img-fluid" />
            </div>
        </div>

        <!-- Th√¥ng tin s·∫£n ph·∫©m -->
        <div class="col-md-6">
            <h3 class="text-success fw-bold">{{ product.Title }}</h3>
            <p class="text-muted" style="font-size: 0.9rem">
                {{ product.Description }}
            </p>

            <!-- Gi√° s·∫£n ph·∫©m (gi√° 1 ly) -->
            <h5 class="text-success fw-semibold product-price" style="font-size: 1.2rem">
                <span>{{ "{:,.0f}".format(cart_item.price_item) }}</span> ‚Ç´
            </h5>

            <form id="form-detail">
                {% set type_code = product.category.TypeCode %}

                {% if type_code in ['DRINK_FULL', 'DRINK_SIZE_ONLY'] %}
                <!-- K√≠ch c·ª° -->
                <div class="my-3">
                    <label class="fw-semibold">Ch·ªçn k√≠ch c·ª°:</label>
                    <div class="btn-group" role="group">
                        <input type="radio" class="btn-check" name="size" id="size-m" value="M" data-size-price="0" {%
                            if cart_item.size=='M' %}checked{% endif %} />
                        <label class="btn btn-outline-secondary btn-sm" for="size-m">
                            M +0 ‚Ç´
                        </label>

                        <input type="radio" class="btn-check" name="size" id="size-l" value="L" data-size-price="7000"
                            {% if cart_item.size=='L' %}checked{% endif %} />
                        <label class="btn btn-outline-secondary btn-sm" for="size-l">
                            L +7,000 ‚Ç´
                        </label>
                    </div>
                </div>
                {% endif %}

                {% if type_code == 'DRINK_FULL' %}
                <!-- ƒê∆∞·ªùng -->
                <div class="my-3">
                    <label class="fw-semibold">Ch·ªçn m·ª©c ƒë∆∞·ªùng:</label>
                    <select class="form-select form-select-sm" name="sugar">
                        {% for val in ["100", "70", "50", "30", "0"] %}
                        <option value="{{ val }}" {% if cart_item.sugar==val %}selected{% endif %}>
                            {% if val != "0" %} {{val}}%{% else %} Kh√¥ng ƒë∆∞·ªùng{% endif %}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- ƒê√° -->
                <div class="my-3">
                    <label class="fw-semibold">Ch·ªçn m·ª©c ƒë√°:</label>
                    <select class="form-select form-select-sm" name="ice">
                        {% for val in ["100", "70", "50", "30", "0"] %}
                        <option value="{{ val }}" {% if cart_item.ice==val %}selected{% endif %}>
                            {% if val != "0" %} {{ val }}%{% else %} Kh√¥ng ƒë√°{% endif %}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Topping -->
                <div class="my-3">
                    <label class="fw-semibold">Ch·ªçn topping:</label>
                    {% if toppings|length > 0 %}
                    {% for topping in toppings %}
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="topping" value="{{ topping.ID }}"
                            id="topping-{{ topping.ID }}" data-topping-price="{{ topping.Price }}" {% if
                            topping.ID|string in cart_item.toppings %}checked{% endif %} />
                        <label class="form-check-label" for="topping-{{ topping.ID }}">
                            {{ topping.Name }} +{{ "{:,.0f}".format(topping.Price) }} ‚Ç´
                        </label>
                    </div>
                    {% endfor %}
                    {% endif %}
                </div>
                {% endif %}

                <!-- S·ªë l∆∞·ª£ng -->
                <div class="my-4 d-flex align-items-center">
                    <label class="me-3 fw-semibold">S·ªë l∆∞·ª£ng:</label>
                    <button type="button" class="btn btn-outline-success btn-sm me-2"
                        onclick="changeQuantity(-1)">‚àí</button>
                    <input type="number" name="quantity" id="quantity" value="{{ cart_item.quantity }}" min="1"
                        class="form-control form-control-sm w-auto text-center" style="width: 60px" />
                    <button type="button" class="btn btn-outline-success btn-sm ms-2"
                        onclick="changeQuantity(1)">+</button>
                </div>
            </form>
        </div>

        <!-- N√∫t c·∫≠p nh·∫≠t -->
        <button type="button" class="btn btn-buy-detail btn-success btn-sm w-100" style="font-size: 0.9rem"
            data-productid="{{ product.ID }}" data-itemname="{{ product.Title }}" data-cart-item-id="{{ cart_item.id }}">
            üíæ C·∫≠p nh·∫≠t gi·ªè h√†ng :
            <span class="price">{{ "{:,.0f}".format(cart_item.total_price) }}</span> ‚Ç´
        </button>

    </div>

    <!-- Gi√° g·ªëc ƒë·ªÉ JS t√≠nh to√°n -->
    <input type="hidden" id="hdf-base-price" value="{{ product.Price }}" />
</div>

<script>
    $(document).ready(function () {
        $("#form-detail").on("submit", function (e) {
            e.preventDefault();
        });

        //Onchage size then update price
        $("input[name='size']").on("change", updatePrice);

        //Onchage topping then update price
        $("input[name='topping']").on("change", updatePrice);

        //Onchange quantity then update price
        $("#quantity").on("input", updatePrice);
    });

    $(".btn-buy-detail").on("click", function () {
        try {
            const id = $(this).data("cart-item-id");
            const productid = $(this).data("productid");
            const name = $(this).data("itemname");
            const quantity = parseInt($("#quantity").val()) || 1;
            const size = $("input[name='size']:checked").val() || "M";
            const sugar = $("select[name='sugar']").val() || "100";
            const ice = $("select[name='ice']").val() || "100";
            const toppings = [];
            $("input[name='topping']:checked").each(function () {
                toppings.push($(this).val());
            });
            // addToCart(id, name, quantity, function () {
            //   console.log("Th√™m v√†o gi·ªè h√†ng th√†nh c√¥ng");
            //   $("#modal-product-detail").modal("hide");
            // });
            updateToCartWithDetails(id, productid, name, quantity, size, sugar, ice, toppings, function () {
                
                updateCartCount();

                loadCart();

                $("#modal-product-detail").modal("hide");
            });
        } catch (e) {
            toastError("C√≥ l·ªói x·∫£y ra khi th√™m v√†o gi·ªè h√†ng");
        }
    });

    function changeQuantity(delta) {
        const qty = $("#quantity");
        let value = parseInt(qty.val());
        value = isNaN(value) ? 1 : value + delta;
        qty.val(value < 1 ? 1 : value);
        updatePrice();
    }

    function updatePrice() {
        const basePrice = parseFloat($("#hdf-base-price").val()) || 0;
        const quantity = parseInt($("#quantity").val()) || 1;

        // Gi√° c·ªông th√™m t·ª´ size
        const upsizePrice =
            parseFloat($("input[name='size']:checked").data("size-price")) || 0;

        // Gi√° c·ªông th√™m t·ª´ topping
        let toppingExtra = 0;
        $("input[name='topping']:checked").each(function () {
            toppingExtra += parseFloat($(this).data("topping-price")) || 0;
        });

        // Gi√° 1 s·∫£n ph·∫©m sau khi c·ªông size & topping
        const pricePerItem = basePrice + upsizePrice + toppingExtra;

        // T·ªïng gi√° = gi√° 1 s·∫£n ph·∫©m * s·ªë l∆∞·ª£ng
        const totalPrice = pricePerItem * quantity;

        // C·∫≠p nh·∫≠t UI
        $(".product-price > span").text(
            pricePerItem.toLocaleString("en-US", { minimumFractionDigits: 0 })
        );
        $(".btn-buy-detail .price").text(
            totalPrice.toLocaleString("en-US", { minimumFractionDigits: 0 })
        );
    }


    function updateToCartWithDetails(id, productid, name, quantity, size, sugar, ice, toppings, callback) {
        var cart = JSON.parse(localStorage.getItem("cart") || "[]");
        const existingItem = cart.find(item => item.id === id);
        if (!existingItem) {
            toastError(`Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m "${name}" trong gi·ªè h√†ng`);
            return;
        }
        existingItem.quantity = quantity;
        existingItem.size = size;
        existingItem.sugar = sugar;
        existingItem.ice = ice;
        existingItem.toppings = toppings;
        
        localStorage.setItem("cart", JSON.stringify(cart));
        toastSuccess(`C·∫≠p nh·∫≠t s·∫£n ph·∫©m "${name}" th√†nh c√¥ng`);

        const cartNumber = $(".cart-number");

        if (cartNumber.length > 0) {
            cartNumber.text(cart.length);
        }

        if (callback) {
            callback();
        }
    }
</script>