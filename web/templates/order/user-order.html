<title>Đơn hàng</title>
<link rel="stylesheet" href="../../static/css/my_order.css">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="{{ url_for('static', filename='css/profile.css') }}" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>


{% extends 'layout/base.html' %}
{% block content %}
<div class="">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3 mb-3">
            {% include 'user/sidebar.html' %}
        </div>

        <!-- Order -->
        <div class="col-md-9">
            <div class="bg-white p-4 border-profile">
                <div class="d-flex justify-content-between align-items-center">
                    <h4 class="mb-4 text-success fw-bold">Đơn hàng của tôi</h4>
                    <button id="btn-refresh-order" class="btn btn-success"><i class="fa-solid fa-rotate"></i></button>
                </div>
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>#</th>
                            <th>Ngày tạo</th>
                            <th>Tổng tiền</th>
                            <th>Người nhận</th>
                            <th>Địa chỉ giao hàng</th>
                            <th>Trạng thái</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for order in orders %}
                        <tr>
                            <td>{{order.ID}}</td>
                            <td>{{order.Created.strftime("%d/%m/%Y %H:%M")}}</td>
                            <td>{{"{:,.0f}".format(order.TotalPayment) }}</td>
                            <td>{{order.CustomerName}}</td>
                            <td>{{order.CustomerAddress}}</td>
                            <td><span class="badge bg-warning text-dark">{{order.Status}}</span></td>
                            <td>
                                <button class="btn btn-sm btn-primary btn-detail" data-id="{{order.ID}}"><i class="fa-solid fa-eye"></i></button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>


            <!-- Modal xem chi tiết -->
            <div class="modal fade" id="orderDetailModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Chi tiết đơn hàng #<span id="order-id"></span></h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body" id="order-detail-body">
                            <p class="text-muted">Đang tải dữ liệu...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
<script>
    $(document).ready(function() {
        // Xử lý sự kiện click vào nút xem chi tiết
        $('.btn-detail').on('click', function() {
            var orderId = $(this).data('id');
            $('#order-id').text(orderId);
            $('#orderDetailModal').modal('show');

            // Gửi yêu cầu AJAX để lấy chi tiết đơn hàng
            $.ajax({
                url: '/api/order/detail/' + orderId,
                method: 'GET',
                success: function(response) {
                    if (response.status_code === "SUCCESS"){
                        var data = response.data;
                        $('#order-detail-body').empty();
                        $('#order-detail-body').html(data);
                        // Cập nhật tiêu đề modal
                        $('#orderDetailModal .modal-title').text('Chi tiết đơn hàng #' + orderId);
                        // Hiển thị modal
                        $('#orderDetailModal').modal('show');
                    }else{
                        toastError("Không thể tải chi tiết đơn hàng. Vui lòng thử lại sau.");
                    }
                },
                error: function() {
                    toastError("Không thể tải chi tiết đơn hàng. Vui lòng thử lại sau.");
                }
            });
        });
    
        // Xử lý sự kiện click vào nút làm mới
        $('#btn-refresh-order').on('click', function() {
            location.reload();
        });
    });
</script>

{% endblock %}