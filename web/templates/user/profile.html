<title>Thông tin cá nhân</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="{{ url_for('static', filename='css/profile.css') }}" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

{% extends 'layout/base.html' %}
{% block content %}
<div class="">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3 mb-3">
            {% include 'user/sidebar.html' %}
        </div>

        <!-- Profile Form -->
        <div class="col-md-9">
            <div class="bg-white p-4 border-profile">
                <h4 class="mb-4 text-success fw-bold">Thông tin cá nhân</h4>
                <form class="profile-form" method="POST" action="{{ url_for('user.update_profile') }}">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Họ & tên</label>
                            <input type="text" class="form-control" name="full_name" value="{{ user.Name or '' }}"
                                readonly>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Số điện thoại</label>
                            <input type="text" class="form-control" name="phone" value="{{ user.Phone or '' }}"
                                readonly>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" name="email" value="{{ user.Email or '' }}"
                                readonly>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Tỉnh/Thành phố</label>
                            <select class="form-select" name="province" id="provinceSelect"
                                data-selected="{{ user.Address.split(',')[-1]|trim if user.Address else '' }}" disabled>
                                <option selected disabled>Chọn tỉnh/thành</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Quận/Huyện</label>
                            <select class="form-select" name="district" id="districtSelect"
                                data-selected="{{ user.Address.split(',')[-2]|trim if user.Address else '' }}" disabled>
                                <option selected disabled>Chọn quận/huyện</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Phường/Xã</label>
                            <select class="form-select" name="ward" id="wardSelect"
                                data-selected="{{ user.Address.split(',')[-3]|trim if user.Address else '' }}" disabled>
                                <option selected disabled>Chọn phường/xã</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Địa chỉ</label>
                            <input type="text" class="form-control" name="address" id="streetAddress"
                                value="{{ user.Address.split(',')[0]|trim if user.Address else '' }}" readonly>
                        </div>
                        <div class="col-md-6 d-flex align-items-end justify-content-end gap-2">
                            <button type="button" class="btn btn-primary" id="editBtn">Cập nhật</button>
                            <button type="button" class="btn btn-success d-none" id="saveBtn">Lưu</button>
                            <button type="button" class="btn btn-secondary d-none" id="cancelBtn">Hủy</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
</body>
<script>
    const provinceSelect = document.querySelector('select[name="province"]');
    const districtSelect = document.querySelector('select[name="district"]');
    const wardSelect = document.querySelector('select[name="ward"]');
    const form = document.querySelector('.profile-form');
    const editBtn = document.getElementById('editBtn');
    const saveBtn = document.getElementById('saveBtn');
    const cancelBtn = document.getElementById('cancelBtn');

    // Load tỉnh/thành
    fetch("https://provinces.open-api.vn/api/?depth=1")
        .then(res => res.json())
        .then(provinces => {
            provinces.forEach(p => {
                const option = new Option(p.name, p.code);
                provinceSelect.add(option);
            });

            // nếu có data-selected thì chọn tự động
            const selectedProvince = provinceSelect.dataset.selected;
            if (selectedProvince) {
                const opt = Array.from(provinceSelect.options).find(o => o.text.trim() === selectedProvince.trim());
                if (opt) {
                    provinceSelect.value = opt.value;
                    provinceSelect.dispatchEvent(new Event('change'));
                }
            }
        });

    // Khi chọn tỉnh -> load quận/huyện
    provinceSelect.addEventListener("change", function () {
        const provinceCode = this.value;
        // giữ 1 option là placeholder
        districtSelect.length = 1;
        wardSelect.length = 1;

        if (!provinceCode) return;

        fetch(`https://provinces.open-api.vn/api/p/${provinceCode}?depth=2`)
            .then(res => res.json())
            .then(data => {
                data.districts.forEach(d => {
                    const option = new Option(d.name, d.code);
                    districtSelect.add(option);
                });

                // tự chọn district nếu có data-selected
                const selectedDistrict = districtSelect.dataset.selected;
                if (selectedDistrict) {
                    const opt = Array.from(districtSelect.options).find(o => o.text.trim() === selectedDistrict.trim());
                    if (opt) {
                        districtSelect.value = opt.value;
                        districtSelect.dispatchEvent(new Event('change'));
                    }
                }
            });
    });

    // Khi chọn quận/huyện -> load phường/xã
    districtSelect.addEventListener("change", function () {
        const districtCode = this.value;
        wardSelect.length = 1;
        if (!districtCode) return;

        fetch(`https://provinces.open-api.vn/api/d/${districtCode}?depth=2`)
            .then(res => res.json())
            .then(data => {
                data.wards.forEach(w => {
                    const option = new Option(w.name, w.code);
                    wardSelect.add(option);
                });

                // tự chọn ward nếu có data-selected
                const selectedWard = wardSelect.dataset.selected;
                if (selectedWard) {
                    const opt = Array.from(wardSelect.options).find(o => o.text.trim() === selectedWard.trim());
                    if (opt) wardSelect.value = opt.value;
                }
            });
    });

    // bật/tắt edit
    function enableEdit() {
        form.querySelectorAll('input, select').forEach(el => {
            if (el.name !== 'phone') {
                el.removeAttribute('readonly');
                el.removeAttribute('disabled');
            }
        });
    }
    function disableEdit() {
        form.querySelectorAll('input, select').forEach(el => {
            if (el.tagName === 'INPUT') el.setAttribute('readonly', true);
            if (el.tagName === 'SELECT') el.setAttribute('disabled', true);
        });
    }

    // remove hidden inputs cũ (phòng trường hợp tồn tại)
    function removeHiddenLocationInputs() {
        ['province_text', 'district_text', 'ward_text'].forEach(name => {
            form.querySelectorAll(`input[name="${name}"]`).forEach(el => el.remove());
        });
    }

    editBtn.addEventListener('click', function () {
        enableEdit();
        editBtn.classList.add('d-none');
        saveBtn.classList.remove('d-none');
        cancelBtn.classList.remove('d-none');
    });

    cancelBtn.addEventListener('click', function () {
        removeHiddenLocationInputs();
        disableEdit();
        cancelBtn.classList.add('d-none');
        saveBtn.classList.add('d-none');
        editBtn.classList.remove('d-none');
    });

    // Lưu: trước khi submit tạo hidden input chứa text (không sao chép phần street)
    saveBtn.addEventListener('click', function () {
        // xoá hidden cũ
        removeHiddenLocationInputs();

        const provinceText = provinceSelect.selectedOptions[0]?.text?.trim() || "";
        const districtText = districtSelect.selectedOptions[0]?.text?.trim() || "";
        const wardText = wardSelect.selectedOptions[0]?.text?.trim() || "";

        if (provinceText) {
            const provinceHidden = document.createElement('input');
            provinceHidden.type = 'hidden';
            provinceHidden.name = 'province_text';
            provinceHidden.value = provinceText;
            form.appendChild(provinceHidden);
        }
        if (districtText) {
            const districtHidden = document.createElement('input');
            districtHidden.type = 'hidden';
            districtHidden.name = 'district_text';
            districtHidden.value = districtText;
            form.appendChild(districtHidden);
        }
        if (wardText) {
            const wardHidden = document.createElement('input');
            wardHidden.type = 'hidden';
            wardHidden.name = 'ward_text';
            wardHidden.value = wardText;
            form.appendChild(wardHidden);
        }

        // gửi form (address input bây giờ chứa only street part)
        form.submit();
    });
</script>

{% endblock %}